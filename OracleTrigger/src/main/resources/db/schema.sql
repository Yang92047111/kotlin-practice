CREATE TABLE users (
    id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    name VARCHAR2(100) NOT NULL,
    email VARCHAR2(100) NOT NULL UNIQUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

CREATE TABLE history (
    id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    user_id NUMBER NOT NULL,
    operation VARCHAR2(50) NOT NULL,
    operation_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    old_value VARCHAR2(4000),
    new_value VARCHAR2(4000),
    FOREIGN KEY (user_id) REFERENCES users(id)
);

CREATE OR REPLACE TRIGGER user_history_trigger
AFTER INSERT OR UPDATE ON users
FOR EACH ROW
BEGIN
    IF INSERTING THEN
        INSERT INTO history (user_id, operation, new_value)
        VALUES (:NEW.id, 'INSERT', :NEW.name);
    ELSIF UPDATING THEN
        INSERT INTO history (user_id, operation, old_value, new_value)
        VALUES (:OLD.id, 'UPDATE', :OLD.name, :NEW.name);
    END IF;
END;