name: PR Quality Check

on:
  pull_request:
    types: [opened, synchronize, reopened]

env:
  JAVA_VERSION: '17'

jobs:
  pr-validation:
    name: PR Validation
    runs-on: ubuntu-latest

    steps:
    - name: Checkout PR code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up JDK ${{ env.JAVA_VERSION }}
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'
        cache: maven

    - name: Cache Maven dependencies
      uses: actions/cache@v4
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2

    - name: Validate PR changes
      run: |
        echo "=== PR Validation ==="
        echo "PR Title: ${{ github.event.pull_request.title }}"
        echo "PR Author: ${{ github.event.pull_request.user.login }}"
        echo "Base Branch: ${{ github.event.pull_request.base.ref }}"
        echo "Head Branch: ${{ github.event.pull_request.head.ref }}"

    - name: Check for breaking changes
      run: |
        echo "Checking for potential breaking changes..."
        git diff --name-only origin/${{ github.event.pull_request.base.ref }}...HEAD | grep -E '\.(kt|java|xml)$' || echo "No source files changed"

    - name: Quick build check
      run: make build

    - name: Run fast tests
      run: |
        echo "Running quick test suite..."
        make test-coroutines

    - name: PR Summary
      run: |
        echo "## PR Check Summary" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Build successful" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Quick tests passed" >> $GITHUB_STEP_SUMMARY
        echo "- ğŸ“ Ready for detailed review" >> $GITHUB_STEP_SUMMARY

  pr-comment:
    name: PR Comment
    runs-on: ubuntu-latest
    needs: pr-validation
    if: github.event.action == 'opened'

    steps:
    - name: Comment on PR
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `## ğŸš€ PR Quality Check Complete!
            
            Your pull request has passed the initial quality checks:
            
            - âœ… **Build Status**: Successful
            - âœ… **Quick Tests**: Passed
            - ğŸ” **Full CI Pipeline**: Running in parallel
            
            ### What's Next?
            - The full CI pipeline will run all tests and quality checks
            - Please ensure your PR description explains the changes
            - Consider adding tests for new functionality
            
            ### Useful Commands
            - \`make test\` - Run all tests locally
            - \`make health\` - Check project health
            - \`make lint\` - Run code quality checks
            
            Thanks for contributing! ğŸ‰`
          })